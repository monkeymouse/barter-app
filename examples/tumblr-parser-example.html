<!DOCTYPE HTML>
<html>
	<head>
		<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.0.7/angular.min.js"></script>
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/async/0.2.7/async.min.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/string.js/1.2.0/string.min.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/less.js/1.4.1/less.min"></script>
		<!--script src="http://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.8/require.min.js" 
			data-main="./barter-boot.js">
		</script-->
		<script>
			var barterModule = angular.module( "barter", [ ] );

			barterModule.directive( "posts",
				function( ){
					return {
						"restrict": "E",
						"link": function( scope, element ){

							var postList = [ ];
							
							var posts = $( element ).children( );
							posts.each( function( ){
								var post = $( this );
								var postType = post.prop( "tagName" ).toLowerCase( )
									.split( "post-" )[ 1 ];
								var postData = {
									"type": postType,
									"components": { }
								};
								postList.push( postData );
								
								var components = postData.components;
								var postComponents = post.children( );
								postComponents.each( function( ){
									var component = $( this );
									var componentType = component.prop( "tagName" ).toLowerCase( )
										.split( "post-" )[ 1 ];
									componentType = S( componentType ).camelize( ).toString( );
									var contents = component.html( )
										.replace( /\n+/g, "" )
										.replace( /\s+/g, " " );

									if( ( /\<[^\<\>]+\>/ ).test( contents ) ){
										contents = $( contents );
										var contentList = [ ];
										//This will remove unwanted data.
										contents.each( function(){
												var content = $( this );
												var contentType = ( content.prop( "tagName" ) || "" ).toLowerCase( );
												if( contentType ){
													contentList.push( content );
												}
											} );

										switch( componentType ){
											case "caption":
											case "description":
												var dataList = { };
												var currentHeader = "heading";
												var currentContents = null;
												_.each( contentList,
													function( content ){
														var contentValue = content.html( ).trim( );
														if( ( /^[-\w\s]+\:/ ).test( contentValue ) ){
															currentHeader = contentValue.match( /^[-\w\s]+/ )[ 0 ].trim( );
															currentHeader = S( currentHeader.toLowerCase( ) ).dasherize( ).toString( );
															dataList[ currentHeader ] = currentContents = [ ];
														}else if( contentValue ){
															dataList[ currentHeader ].push( contentValue );
														}
													} );
												contentList = dataList;	
												break;

											case "imageUrl":
												var dataList = { };
												_.each( contentList,
													function( content ){
														var size = content.attr( "size" );
														var url = content.html( ).trim( );
														if( url ){
															dataList[ size ] = url;
														}
													} );
												contentList = dataList;
												break;

											case "tags":
												var dataList = { };
												_.each( contentList,
													function( content ){
														var name = $( "tag-name", content ).html( ).trim( );
														var url = $( "tag-url", content ).html( ).trim( );
														dataList[ name ] = url;
													} );
												contentList = dataList
												break;
										}

										contents = contentList;
									}
									components[ componentType ] = contents;
								} );
							} );
						}
					};
				} );

		</script>
		<title barter-title>
		</title>
	</head>
	<body ng-app="barter">
		<barter-app
			class="barter-app hide"
			access-key="''"
			email="'barter@gmail.com'"
			site-url="'barter.tumblr.com'"
			site-name="'barter'"
			settings="''"
			environment="'data-bank'">

			
			
			<!--We put it here because tumblr parses the html before loading-->
			<tumblr-data>
				<!--This will render if a tag url is accessed-->
				{block:TagPage}
				<posts-on-tag>
					<tag>
						<tag-name>{Tag}</tag-name>
						<tag-url>{TagURL}</tag-url>
					</tag>
				</posts-on-tag>
				{/block:TagPage}
				
				<posts>
				{block:Posts}
					{block:Text}
					<post-text>
						{block:Title}
						<post-title>{Title}</post-title>
						{/block:Title}

						<post-body>{Body}</post-body>
						
						{block:Date}
						<post-date>{Timestamp}</post-date>
						{/block:Date}
						
						{block:NoteCount}
						<post-like-count>{NoteCount}</post-like-count>
						{/block:NoteCount}
						
						{block:HasTags}
						<post-tags>
							{block:Tags} 
							<tag>
								<tag-name>{Tag}</tag-name>
								<tag-url>{TagURL}</tag-url>
							</tag>
							{/block:Tags}
						</post-tags>
						{/block:HasTags}
					</post-text>
					{/block:Text}

					{block:Photo}
					<post-image>
						<post-image-url>
							<image-url size="500">{PhotoURL-500}</image-url>
							<image-url size="400">{PhotoURL-400}</image-url>
							<image-url size="250">{PhotoURL-250}</image-url>
							<image-url size="100">{PhotoURL-100}</image-url>
							<image-url size="75">{PhotoURL-75sq}</image-url>
							{block:HighRes}
							<image-url size="1280">{PhotoURL-1280}</image-url>
							<image-url size="2560">{PhotoURL-2560}</image-url>
							{/block:HighRes}
						</post-image-url>

						{block:Caption}
						<post-caption>{Caption}</post-caption>
						{/block:Caption}
						
						{block:Date}
						<post-date>{Timestamp}</post-date>
						{/block:Date}
						
						{block:NoteCount}
						<post-like-count>{NoteCount}</post-like-count>
						{/block:NoteCount}
						
						{block:HasTags}
						<post-tags>
							{block:Tags} 
							<tag>
								<tag-name>{Tag}</tag-name>
								<tag-url>{TagURL}</tag-url>
							</tag>
							{/block:Tags}
						</post-tags>
						{/block:HasTags}
					</post-image>
					{/block:Photo}
				{/block:Posts}
				</posts>
			</tumblr-data>
		</barter-app>
	</body>
</html>